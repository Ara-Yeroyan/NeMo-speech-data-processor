processors_to_run: "0:"
workspace_dir: /mnt/ssd8/cc_sdp
workspace_dir_diar: /mnt/ssd8/cc_sdp/diarize

processors:
  - _target_: sdp.processors.datasets.commoncrawl.CreateInitialManifestCC
    raw_data_dir: /mnt/ssd8/cc_download/videos_and_transcripts_large_16_cores_output/video_output2
    video_field: "source_video"
    text_field: "texts"
    key_field: "key"

  - _target_: sdp.processors.datasets.commoncrawl.ReadParquet
    raw_data_dir: /mnt/ssd8/cc_download/videos_and_transcripts_large_16_cores_output/video_output2
    output_video_field: video_url
    output_caption_field: caption_url
    key_field: key

  - _target_: sdp.processors.datasets.commoncrawl.FfmpegConvert
    # input_manifest_file:${workspace_dir}/manifest_urls.json
    resampled_audio_dir: ${workspace_dir}/audio 
    target_samplerate: 16000
    target_nchannels: 1
    input_field: "source_video"
    output_field: "source_audio"
    key_field: "key"

  - _target_: sdp.processors.datasets.commoncrawl.AudioDuration
    input_field: source_audio
    output_field: duration

  - _target_: sdp.processors.datasets.commoncrawl.PreserveByValue
    output_manifest_file: ${workspace_dir}/manifest0.json
    input_field: duration
    target_value: 0
    operator: gt

  - _target_: sdp.processors.datasets.commoncrawl.TxtToVtt
    output_manifest_file: ${workspace_dir}/manifest1.json
    vtt_files_dir: ${workspace_dir}/vtts/
    key_field: "key"
    text_field: "texts"
    vtt_field: "vtt_filepath"

  - _target_: sdp.processors.datasets.commoncrawl.AllVttText
    output_manifest_file: ${workspace_dir}/manifest2.json
    input_filepath_field: vtt_filepath
    output_text_field: vtt_text

  - _target_: sdp.processors.datasets.commoncrawl.TextLid
    output_manifest_file: ${workspace_dir}/manifest3.json
    input_text_field: vtt_text
    output_lang_field: text_lang
    device: cuda
    pretrained_model: "jb2k/bert-base-multilingual-cased-language-detection"

  - _target_: sdp.processors.datasets.commoncrawl.Lang2Iso
    output_manifest_file: ${workspace_dir}/manifest4.json
    input_lang_field: text_lang
    output_lang_field: text_lang

  - _target_: sdp.processors.datasets.commoncrawl.AudioLid
    output_manifest_file: ${workspace_dir}/manifest5.json
    input_audio_field: audios
    output_lang_field: audio_lang
    device: cuda
    pretrained_model: "langid_ambernet"

  - _target_: sdp.processors.datasets.commoncrawl.SplitByVttSentence
    output_manifest_file: ${workspace_dir}/manifest6a.json
    splited_audio_dir: ${workspace_dir}/splited_s/
    source_audio_field: audios
    vtt_field: "vtt_filepath"
    target_audio_field: "audio_filepath"
    duration_field: "duration"
    text_field: "text"
    proxy_fields: [audio_lang, text_lang, audios]
    duration_threshold: 10.0
    
  - _target_: sdp.processors.DropHighLowDuration
    output_manifest_file: ${workspace_dir}/manifest7a.json
    high_duration_threshold: 40
    low_duration_threshold: 0.02

  - _target_: sdp.processors.DuplicateFields
    output_manifest_file: ${workspace_dir}/manifest8a.json
    duplicate_fields: {"audios": "source_audio"}

  - _target_: sdp.processors.KeepOnlySpecifiedFields
    output_manifest_file: ${workspace_dir}/manifest9a.json
    fields_to_keep: ["audio_filepath", "duration", "text", "audio_lang", "text_lang", "source_audio"]

  - _target_: sdp.processors.datasets.commoncrawl.EvalBandwidth
    output_manifest_file: ${workspace_dir}/manifest10a.json
    input_field: audio_filepath
    output_field: bandwidth

  - _target_: sdp.processors.RenameFields
    input_manifest_file: ${workspace_dir}/manifest5.json
    output_manifest_file: ${workspace_dir_diar}/manifest0.json
    rename_fields: {"source_audio":"audio_filepath"}

  - _target_: sdp.processors.datasets.commoncrawl.Subprocess
    input_manifest_arg: "diarizer.manifest_filepath"
    arg_separator: "="
    cmd: "python /home/nkarpov/workspace/NeMo/examples/speaker_tasks/diarization/clustering_diarizer/offline_diar_infer.py \
    --config-path=/home/nkarpov/workspace/NeMo/examples/speaker_tasks/diarization/conf/inference/ --config-name=diar_infer_general.yaml \
    diarizer.out_dir=${workspace_dir_diar} \
    diarizer.speaker_embeddings.parameters.save_embeddings=False \
    diarizer.vad.model_path=/home/nkarpov/ckpts/diar/vad_multilingual_marblenet.nemo \
    diarizer.speaker_embeddings.model_path=/home/nkarpov/ckpts/diar/titanet-l.nemo \
    diarizer.clustering.parameters.max_num_speakers=4 \
    diarizer.clustering.parameters.enhanced_count_thres=80 \
    diarizer.vad.parameters.onset=0.1 \
    diarizer.vad.parameters.offset=0.1 "